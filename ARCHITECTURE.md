# eTurtle — Architecture Document

> Delivery management platform: Backend API + Admin Dashboard + Driver Mobile App

---

## Table of Contents

1. [Package Status State Machine](#1-package-status-state-machine)
2. [Database Schema](#2-database-schema)
3. [Auto-Assignment Algorithm](#3-auto-assignment-algorithm)
4. [REST API Contract](#4-rest-api-contract)
5. [Folder Structure](#5-folder-structure)
6. [Code Standards Summary](#6-code-standards-summary)

---

## 1. Package Status State Machine

Every package progresses through these states. Only the transitions shown are
valid — the backend rejects any other status change.

```
                        ┌─────────────┐
                        │  registered  │
                        └──────┬──────┘
                               │ (auto-assignment finds vehicle)
                        ┌──────▼──────┐
                        │   assigned   │
                        └──────┬──────┘
                               │ (admin approves route)
                        ┌──────▼──────┐
              ┌────────►│  in_transit  │◄────────┐
              │         └──────┬──────┘         │
              │                │                 │
              │         ┌──────▼──────┐         │
              │         │   at_depot   ├─────────┘
              │         └──────┬──────┘  (leaves depot,
              │                │          continues route)
              │         ┌──────▼──────────┐
              │         │ out_for_delivery │
              │         └───┬─────────┬───┘
              │             │         │
              │    ┌────────▼──┐  ┌───▼─────┐
              │    │  delivered │  │ returned │
              │    └───────────┘  └─────────┘
              │
        ┌─────┴─────┐
        │  cancelled │  (from any non-terminal state)
        └───────────┘
```

### States

| State              | Description                                          |
|--------------------|------------------------------------------------------|
| `registered`       | Package entered into the system, awaiting assignment  |
| `assigned`         | Auto-assigned to a vehicle; route pending approval    |
| `in_transit`       | Route approved; package moving between depots         |
| `at_depot`         | Arrived at an intermediate depot hub                  |
| `out_for_delivery` | On the final leg heading to destination address       |
| `delivered`        | Driver confirmed delivery (terminal)                  |
| `returned`         | Delivery failed, returned to sender (terminal)        |
| `cancelled`        | Cancelled by admin (terminal)                         |

### Valid Transitions

| From               | To                 | Trigger                              |
|--------------------|--------------------|--------------------------------------|
| `registered`       | `assigned`         | Auto-assignment finds suitable vehicle|
| `registered`       | `cancelled`        | Admin cancels                        |
| `assigned`         | `in_transit`       | Admin approves the route             |
| `assigned`         | `registered`       | Route rejected, vehicle unassigned   |
| `assigned`         | `cancelled`        | Admin cancels                        |
| `in_transit`       | `at_depot`         | Vehicle arrives at intermediate depot|
| `in_transit`       | `out_for_delivery` | Vehicle on final delivery leg        |
| `in_transit`       | `cancelled`        | Admin cancels                        |
| `at_depot`         | `in_transit`       | Vehicle departs depot                |
| `at_depot`         | `cancelled`        | Admin cancels                        |
| `out_for_delivery` | `delivered`        | Driver confirms delivery             |
| `out_for_delivery` | `returned`         | Delivery failed                      |
| `out_for_delivery` | `cancelled`        | Admin cancels                        |

---

## 2. Database Schema

All tables use `snake_case`. Primary keys are UUIDs generated by `gen_random_uuid()`.
Every table has `created_at` and `updated_at` timestamps.

### 2.1 `depots`

| Column       | Type           | Constraints                |
|--------------|----------------|----------------------------|
| `id`         | `UUID`         | PK, DEFAULT gen_random_uuid() |
| `name`       | `VARCHAR(255)` | NOT NULL                   |
| `address`    | `VARCHAR(500)` | NOT NULL                   |
| `latitude`   | `DECIMAL(10,8)`| NOT NULL                   |
| `longitude`  | `DECIMAL(11,8)`| NOT NULL                   |
| `is_active`  | `BOOLEAN`      | NOT NULL, DEFAULT TRUE     |
| `created_at` | `TIMESTAMPTZ`  | NOT NULL, DEFAULT NOW()    |
| `updated_at` | `TIMESTAMPTZ`  | NOT NULL, DEFAULT NOW()    |

**Indexes:** `idx_depots_is_active` on `(is_active)`

---

### 2.2 `vehicles`

| Column              | Type            | Constraints                          |
|---------------------|-----------------|--------------------------------------|
| `id`                | `UUID`          | PK, DEFAULT gen_random_uuid()        |
| `license_plate`     | `VARCHAR(20)`   | NOT NULL, UNIQUE                     |
| `type`              | `VARCHAR(20)`   | NOT NULL, CHECK (type IN ('van','truck','motorcycle')) |
| `weight_capacity_kg`| `DECIMAL(10,2)` | NOT NULL, CHECK (> 0)                |
| `volume_capacity_cbm`| `DECIMAL(10,4)`| NOT NULL, CHECK (> 0)                |
| `current_depot_id`  | `UUID`          | FK → depots.id, NULLABLE             |
| `status`            | `VARCHAR(20)`   | NOT NULL, DEFAULT 'available', CHECK (status IN ('available','in_transit','maintenance')) |
| `created_at`        | `TIMESTAMPTZ`   | NOT NULL, DEFAULT NOW()              |
| `updated_at`        | `TIMESTAMPTZ`   | NOT NULL, DEFAULT NOW()              |

**Indexes:**
- `idx_vehicles_current_depot` on `(current_depot_id)`
- `idx_vehicles_status` on `(status)`
- `idx_vehicles_type` on `(type)`

---

### 2.3 `users`

| Column         | Type           | Constraints                            |
|----------------|----------------|----------------------------------------|
| `id`           | `UUID`         | PK, DEFAULT gen_random_uuid()          |
| `email`        | `VARCHAR(255)` | NOT NULL, UNIQUE                       |
| `password_hash`| `VARCHAR(255)` | NOT NULL                               |
| `full_name`    | `VARCHAR(255)` | NOT NULL                               |
| `role`         | `VARCHAR(20)`  | NOT NULL, CHECK (role IN ('admin','driver')) |
| `vehicle_id`   | `UUID`         | FK → vehicles.id, NULLABLE, UNIQUE     |
| `is_active`    | `BOOLEAN`      | NOT NULL, DEFAULT TRUE                 |
| `created_at`   | `TIMESTAMPTZ`  | NOT NULL, DEFAULT NOW()                |
| `updated_at`   | `TIMESTAMPTZ`  | NOT NULL, DEFAULT NOW()                |

**Indexes:**
- `idx_users_role` on `(role)`
- `idx_users_vehicle` on `(vehicle_id)`
- `idx_users_email` on `(email)` (covered by UNIQUE)

---

### 2.4 `packages`

| Column                | Type            | Constraints                        |
|-----------------------|-----------------|------------------------------------|
| `id`                  | `UUID`          | PK, DEFAULT gen_random_uuid()      |
| `tracking_number`     | `VARCHAR(50)`   | NOT NULL, UNIQUE                   |
| `origin_address`      | `VARCHAR(500)`  | NOT NULL                           |
| `origin_depot_id`     | `UUID`          | FK → depots.id, NULLABLE           |
| `destination_address` | `VARCHAR(500)`  | NOT NULL                           |
| `destination_depot_id`| `UUID`          | FK → depots.id, NULLABLE           |
| `weight_kg`           | `DECIMAL(10,2)` | NOT NULL, CHECK (> 0)              |
| `length_cm`           | `DECIMAL(10,2)` | NOT NULL, CHECK (> 0)              |
| `width_cm`            | `DECIMAL(10,2)` | NOT NULL, CHECK (> 0)              |
| `height_cm`           | `DECIMAL(10,2)` | NOT NULL, CHECK (> 0)              |
| `volume_cbm`          | `DECIMAL(10,4)` | GENERATED ALWAYS AS (length_cm * width_cm * height_cm / 1000000.0) STORED |
| `contents_description`| `TEXT`          | NULLABLE                           |
| `current_status`      | `VARCHAR(30)`   | NOT NULL, DEFAULT 'registered'     |
| `assigned_vehicle_id` | `UUID`          | FK → vehicles.id, NULLABLE         |
| `created_at`          | `TIMESTAMPTZ`   | NOT NULL, DEFAULT NOW()            |
| `updated_at`          | `TIMESTAMPTZ`   | NOT NULL, DEFAULT NOW()            |

**Indexes:**
- `idx_packages_tracking_number` on `(tracking_number)` (covered by UNIQUE)
- `idx_packages_current_status` on `(current_status)`
- `idx_packages_assigned_vehicle` on `(assigned_vehicle_id)`
- `idx_packages_origin_depot` on `(origin_depot_id)`
- `idx_packages_destination_depot` on `(destination_depot_id)`

---

### 2.5 `package_status_history`

| Column             | Type           | Constraints                    |
|--------------------|----------------|--------------------------------|
| `id`               | `UUID`         | PK, DEFAULT gen_random_uuid()  |
| `package_id`       | `UUID`         | FK → packages.id, NOT NULL     |
| `status`           | `VARCHAR(30)`  | NOT NULL                       |
| `changed_by_user_id`| `UUID`        | FK → users.id, NULLABLE        |
| `note`             | `TEXT`         | NULLABLE                       |
| `created_at`       | `TIMESTAMPTZ`  | NOT NULL, DEFAULT NOW()        |

**Indexes:**
- `idx_psh_package_id` on `(package_id)`
- `idx_psh_created_at` on `(created_at)`

---

### 2.6 `routes`

| Column             | Type          | Constraints                          |
|--------------------|---------------|--------------------------------------|
| `id`               | `UUID`        | PK, DEFAULT gen_random_uuid()        |
| `vehicle_id`       | `UUID`        | FK → vehicles.id, NOT NULL           |
| `driver_id`        | `UUID`        | FK → users.id, NOT NULL              |
| `route_date`       | `DATE`        | NOT NULL                             |
| `status`           | `VARCHAR(20)` | NOT NULL, DEFAULT 'pending', CHECK (status IN ('pending','approved','rejected','in_progress','completed')) |
| `approved_by_user_id`| `UUID`      | FK → users.id, NULLABLE              |
| `approved_at`      | `TIMESTAMPTZ` | NULLABLE                             |
| `created_at`       | `TIMESTAMPTZ` | NOT NULL, DEFAULT NOW()              |
| `updated_at`       | `TIMESTAMPTZ` | NOT NULL, DEFAULT NOW()              |

**Constraints:** `uq_routes_vehicle_date` UNIQUE on `(vehicle_id, route_date)`

**Indexes:**
- `idx_routes_status` on `(status)`
- `idx_routes_route_date` on `(route_date)`
- `idx_routes_driver` on `(driver_id)`

---

### 2.7 `route_stops`

| Column              | Type          | Constraints                      |
|---------------------|---------------|----------------------------------|
| `id`                | `UUID`        | PK, DEFAULT gen_random_uuid()    |
| `route_id`          | `UUID`        | FK → routes.id, NOT NULL         |
| `depot_id`          | `UUID`        | FK → depots.id, NOT NULL         |
| `stop_order`        | `INTEGER`     | NOT NULL, CHECK (> 0)            |
| `estimated_arrival` | `TIMESTAMPTZ` | NULLABLE                         |
| `actual_arrival`    | `TIMESTAMPTZ` | NULLABLE                         |
| `created_at`        | `TIMESTAMPTZ` | NOT NULL, DEFAULT NOW()          |

**Constraints:** `uq_route_stops_order` UNIQUE on `(route_id, stop_order)`

**Indexes:**
- `idx_route_stops_route` on `(route_id)`

---

### 2.8 `route_packages`

| Column          | Type   | Constraints                       |
|-----------------|--------|-----------------------------------|
| `id`            | `UUID` | PK, DEFAULT gen_random_uuid()     |
| `route_id`      | `UUID` | FK → routes.id, NOT NULL          |
| `package_id`    | `UUID` | FK → packages.id, NOT NULL        |
| `pickup_stop_id`| `UUID` | FK → route_stops.id, NOT NULL     |
| `dropoff_stop_id`| `UUID`| FK → route_stops.id, NOT NULL     |
| `created_at`    | `TIMESTAMPTZ` | NOT NULL, DEFAULT NOW()     |

**Constraints:** `uq_route_packages` UNIQUE on `(route_id, package_id)`

**Indexes:**
- `idx_route_packages_route` on `(route_id)`
- `idx_route_packages_package` on `(package_id)`

---

### 2.9 `deliveries`

| Column         | Type          | Constraints                     |
|----------------|---------------|---------------------------------|
| `id`           | `UUID`        | PK, DEFAULT gen_random_uuid()   |
| `package_id`   | `UUID`        | FK → packages.id, NOT NULL, UNIQUE |
| `route_id`     | `UUID`        | FK → routes.id, NOT NULL        |
| `driver_id`    | `UUID`        | FK → users.id, NOT NULL         |
| `delivered_at` | `TIMESTAMPTZ` | NOT NULL, DEFAULT NOW()         |
| `note`         | `TEXT`        | NULLABLE                        |
| `created_at`   | `TIMESTAMPTZ` | NOT NULL, DEFAULT NOW()         |

**Indexes:**
- `idx_deliveries_driver` on `(driver_id)`
- `idx_deliveries_delivered_at` on `(delivered_at)`
- `idx_deliveries_route` on `(route_id)`

---

### Entity Relationship Diagram

```
  depots ─────────────┬──────────────────┐
    │                 │                  │
    │ current_depot   │ origin/dest      │ depot stop
    ▼                 ▼                  ▼
  vehicles ◄───── packages          route_stops
    │    │            │    │             │
    │    │ assigned    │    │             │
    │    └────────────┘    │             │
    │                      │             │
    │ vehicle              │ package     │ pickup/dropoff
    ▼                      ▼             ▼
  routes ◄──────────── route_packages ──►route_stops
    │
    │ route
    ▼
  deliveries ──► packages (1:1)
    │
    │ driver
    ▼
  users ──────► vehicles (1:1 optional)
```

---

## 3. Auto-Assignment Algorithm

When a new package is created via `POST /api/packages`, the system runs the
assignment algorithm. The goal: find the best available vehicle at the depot
nearest to the package origin that has sufficient remaining capacity.

### Algorithm: Nearest-Depot Capacity-Fit

```
FUNCTION assignPackage(package):

  1. FIND nearest depot to package.origin_address
     - Use Haversine distance from (origin_lat, origin_lng) to each active depot
     - Set package.origin_depot_id = nearest depot

  2. FIND nearest depot to package.destination_address
     - Set package.destination_depot_id = nearest depot

  3. GET all vehicles WHERE:
     - vehicle.current_depot_id = package.origin_depot_id
     - vehicle.status = 'available'

  4. For each candidate vehicle:
     a. CALCULATE current load:
        - sum(weight_kg) of all packages assigned to this vehicle
          that are NOT in a terminal state (delivered/returned/cancelled)
        - sum(volume_cbm) of same
     b. CALCULATE remaining capacity:
        - remaining_weight = vehicle.weight_capacity_kg - current_weight_load
        - remaining_volume = vehicle.volume_capacity_cbm - current_volume_load
     c. CHECK fit:
        - package.weight_kg <= remaining_weight
        - package.volume_cbm <= remaining_volume

  5. FILTER to vehicles where package fits

  6. SCORE remaining candidates:
     - score = (remaining_weight - package.weight_kg) / vehicle.weight_capacity_kg
             + (remaining_volume - package.volume_cbm) / vehicle.volume_capacity_cbm
     - LOWER score = tighter fit = preferred (bin-packing heuristic)

  7. SELECT vehicle with lowest score (best fit)

  8. IF no vehicle found:
     - Package stays in 'registered' status
     - No vehicle assigned (awaits manual assignment or future retry)
     - RETURN null

  9. ASSIGN:
     - Set package.assigned_vehicle_id = selected vehicle
     - Set package.current_status = 'assigned'
     - Record status change in package_status_history
     - TRIGGER route generation (see below)
     - RETURN vehicle
```

### Route Generation (triggered by assignment)

```
FUNCTION generateRoute(vehicle, package, routeDate = TODAY):

  1. CHECK if route exists for (vehicle.id, routeDate)

  2. IF route exists AND route.status = 'pending':
     - Add package.origin_depot as a stop (if not already in stop list)
     - Add package.destination_depot as a stop (if not already in stop list)
     - Re-order stops by geographic proximity (nearest-neighbor)
     - Add route_package record linking package to pickup/dropoff stops
     - RETURN updated route

  3. IF no route exists:
     - CREATE route with status = 'pending'
     - CREATE route_stops for origin depot and destination depot
     - CREATE route_package record
     - RETURN new route

  4. IF existing route.status != 'pending' (already approved/in_progress):
     - CREATE new route for next available date
     - Follow step 3
```

### Stop Ordering: Nearest-Neighbor Heuristic

When multiple stops exist on a route, order them:

1. Start from the vehicle's current depot
2. Pick the nearest unvisited depot as the next stop
3. Repeat until all depots visited

This is a greedy TSP approximation — good enough for daily route planning.

---

## 4. REST API Contract

Base URL: `/api`

All responses use consistent shape:
```json
// Success
{ "success": true, "data": { ... } }

// Success (list)
{ "success": true, "data": { "items": [...], "total": 100, "page": 1, "pageSize": 20 } }

// Error
{ "success": false, "error": "Human-readable error message" }
```

### 4.1 Authentication

#### `POST /api/auth/login`

Authenticate a user and receive a JWT.

**Request:**
```json
{
  "email": "admin@eturtle.com",
  "password": "securepassword"
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbG...",
    "user": {
      "id": "uuid",
      "email": "admin@eturtle.com",
      "fullName": "Admin User",
      "role": "admin"
    }
  }
}
```

**Errors:** 401 (invalid credentials)

---

#### `GET /api/auth/me`

Get current authenticated user profile.

**Headers:** `Authorization: Bearer <token>`

**Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "email": "admin@eturtle.com",
    "fullName": "Admin User",
    "role": "admin",
    "vehicleId": null
  }
}
```

---

### 4.2 Dashboard

#### `GET /api/dashboard/stats`

**Auth:** Admin only

**Response (200):**
```json
{
  "success": true,
  "data": {
    "totalPackages": 1250,
    "pendingRoutes": 8,
    "activeVehicles": 23,
    "deliveriesToday": 47
  }
}
```

---

### 4.3 Depots

#### `GET /api/depots`

**Auth:** Admin or Driver

**Query params:** `?page=1&pageSize=20&sortBy=name&sortOrder=asc&isActive=true`

**Response (200):**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "name": "Central Depot",
        "address": "123 Main St",
        "latitude": 42.69770000,
        "longitude": 23.32190000,
        "isActive": true,
        "vehicleCount": 5,
        "createdAt": "2026-01-15T10:00:00Z",
        "updatedAt": "2026-01-15T10:00:00Z"
      }
    ],
    "total": 12,
    "page": 1,
    "pageSize": 20
  }
}
```

#### `GET /api/depots/:id`

**Auth:** Admin or Driver

**Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "name": "Central Depot",
    "address": "123 Main St",
    "latitude": 42.69770000,
    "longitude": 23.32190000,
    "isActive": true,
    "vehicleCount": 5,
    "vehicles": [
      { "id": "uuid", "licensePlate": "CA1234AB", "type": "van" }
    ],
    "createdAt": "2026-01-15T10:00:00Z",
    "updatedAt": "2026-01-15T10:00:00Z"
  }
}
```

#### `POST /api/depots`

**Auth:** Admin only

**Request:**
```json
{
  "name": "Central Depot",
  "address": "123 Main St",
  "latitude": 42.69770000,
  "longitude": 23.32190000
}
```

**Validation:** name (required, 1-255 chars), address (required, 1-500 chars), latitude (-90 to 90), longitude (-180 to 180)

**Response (201):** Created depot object

#### `PUT /api/depots/:id`

**Auth:** Admin only

**Request:** Same shape as POST (all fields optional)

**Response (200):** Updated depot object

---

### 4.4 Vehicles

#### `GET /api/vehicles`

**Auth:** Admin or Driver

**Query params:** `?page=1&pageSize=20&sortBy=licensePlate&sortOrder=asc&type=van&depotId=uuid&status=available`

**Response item shape:**
```json
{
  "id": "uuid",
  "licensePlate": "CA1234AB",
  "type": "van",
  "weightCapacityKg": 1500.00,
  "volumeCapacityCbm": 12.0000,
  "currentDepotId": "uuid",
  "currentDepotName": "Central Depot",
  "status": "available",
  "assignedDriver": {
    "id": "uuid",
    "fullName": "John Driver"
  },
  "currentLoadKg": 450.00,
  "currentLoadCbm": 3.5000,
  "createdAt": "2026-01-15T10:00:00Z",
  "updatedAt": "2026-01-15T10:00:00Z"
}
```

#### `GET /api/vehicles/:id`

**Auth:** Admin or Driver

**Response:** Full vehicle object with assigned driver details

#### `POST /api/vehicles`

**Auth:** Admin only

**Request:**
```json
{
  "licensePlate": "CA1234AB",
  "type": "van",
  "weightCapacityKg": 1500.00,
  "volumeCapacityCbm": 12.0000,
  "currentDepotId": "uuid"
}
```

**Validation:** licensePlate (required, unique), type (required, enum), capacities (required, > 0), currentDepotId (optional, valid UUID)

#### `PUT /api/vehicles/:id`

**Auth:** Admin only

**Request:** Same shape as POST (all fields optional)

---

### 4.5 Users

#### `GET /api/users`

**Auth:** Admin only

**Query params:** `?page=1&pageSize=20&sortBy=fullName&sortOrder=asc&role=driver&isActive=true`

**Response item shape:**
```json
{
  "id": "uuid",
  "email": "driver@eturtle.com",
  "fullName": "John Driver",
  "role": "driver",
  "vehicleId": "uuid",
  "vehicleLicensePlate": "CA1234AB",
  "isActive": true,
  "createdAt": "2026-01-15T10:00:00Z",
  "updatedAt": "2026-01-15T10:00:00Z"
}
```

#### `GET /api/users/:id`

**Auth:** Admin only

**Response:** Full user object (never includes password_hash)

#### `POST /api/users`

**Auth:** Admin only

**Request:**
```json
{
  "email": "driver@eturtle.com",
  "password": "securepassword",
  "fullName": "John Driver",
  "role": "driver",
  "vehicleId": "uuid"
}
```

**Validation:** email (required, valid email, unique), password (required, min 8 chars), fullName (required, 1-255 chars), role (required, enum), vehicleId (optional, valid UUID, must be unassigned)

#### `PUT /api/users/:id`

**Auth:** Admin only

**Request:** Same shape as POST (all optional, password only if changing). `vehicleId` set to `null` to unassign.

---

### 4.6 Packages

#### `GET /api/packages`

**Auth:** Admin or Driver

**Query params:** `?page=1&pageSize=20&sortBy=createdAt&sortOrder=desc&status=registered&originDepotId=uuid&destinationDepotId=uuid`

**Response item shape:**
```json
{
  "id": "uuid",
  "trackingNumber": "ET-20260224-A1B2C3",
  "originAddress": "456 Oak Ave",
  "originDepotId": "uuid",
  "originDepotName": "North Depot",
  "destinationAddress": "789 Elm St",
  "destinationDepotId": "uuid",
  "destinationDepotName": "South Depot",
  "weightKg": 5.50,
  "lengthCm": 40.00,
  "widthCm": 30.00,
  "heightCm": 20.00,
  "volumeCbm": 0.0240,
  "contentsDescription": "Electronics",
  "currentStatus": "assigned",
  "assignedVehicleId": "uuid",
  "assignedVehicleLicensePlate": "CA1234AB",
  "createdAt": "2026-02-24T10:00:00Z",
  "updatedAt": "2026-02-24T10:30:00Z"
}
```

#### `GET /api/packages/:id`

**Auth:** Admin or Driver

**Response:** Full package object including `statusHistory` array:
```json
{
  "success": true,
  "data": {
    "...package fields...",
    "statusHistory": [
      {
        "id": "uuid",
        "status": "registered",
        "changedByUserId": "uuid",
        "changedByUserName": "Admin User",
        "note": null,
        "createdAt": "2026-02-24T10:00:00Z"
      },
      {
        "id": "uuid",
        "status": "assigned",
        "changedByUserId": null,
        "changedByUserName": "System",
        "note": "Auto-assigned to vehicle CA1234AB",
        "createdAt": "2026-02-24T10:00:01Z"
      }
    ]
  }
}
```

#### `POST /api/packages`

**Auth:** Admin only

**Request:**
```json
{
  "originAddress": "456 Oak Ave",
  "destinationAddress": "789 Elm St",
  "weightKg": 5.50,
  "lengthCm": 40.00,
  "widthCm": 30.00,
  "heightCm": 20.00,
  "contentsDescription": "Electronics"
}
```

**Behavior:** Creates package → runs auto-assignment → returns package with assignment result.

**Validation:** originAddress (required), destinationAddress (required), weightKg (required, > 0), dimensions (required, > 0), contentsDescription (optional)

**Response (201):** Created package with `currentStatus` of `assigned` (if vehicle found) or `registered` (if not).

#### `PUT /api/packages/:id`

**Auth:** Admin only

**Request:** Updatable fields: originAddress, destinationAddress, weightKg, dimensions, contentsDescription. Status changes go through dedicated transitions, not direct update.

---

### 4.7 Routes

#### `GET /api/routes`

**Auth:** Admin or Driver

**Query params:** `?page=1&pageSize=20&sortBy=routeDate&sortOrder=desc&status=pending&driverId=uuid&vehicleId=uuid&dateFrom=2026-02-01&dateTo=2026-02-28`

**Response item shape:**
```json
{
  "id": "uuid",
  "vehicleId": "uuid",
  "vehicleLicensePlate": "CA1234AB",
  "driverId": "uuid",
  "driverName": "John Driver",
  "routeDate": "2026-02-24",
  "status": "pending",
  "stopCount": 4,
  "packageCount": 12,
  "approvedByUserName": null,
  "approvedAt": null,
  "createdAt": "2026-02-24T08:00:00Z",
  "updatedAt": "2026-02-24T08:00:00Z"
}
```

#### `GET /api/routes/:id`

**Auth:** Admin or Driver

**Response:** Full route with stops and packages:
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "vehicleId": "uuid",
    "vehicleLicensePlate": "CA1234AB",
    "vehicleType": "van",
    "driverId": "uuid",
    "driverName": "John Driver",
    "routeDate": "2026-02-24",
    "status": "pending",
    "approvedByUserName": null,
    "approvedAt": null,
    "stops": [
      {
        "id": "uuid",
        "depotId": "uuid",
        "depotName": "North Depot",
        "stopOrder": 1,
        "estimatedArrival": "2026-02-24T09:00:00Z",
        "actualArrival": null,
        "pickupPackages": [
          { "id": "uuid", "trackingNumber": "ET-...", "destinationAddress": "..." }
        ],
        "dropoffPackages": []
      }
    ],
    "createdAt": "2026-02-24T08:00:00Z",
    "updatedAt": "2026-02-24T08:00:00Z"
  }
}
```

#### `POST /api/routes`

**Auth:** Admin only (manual route creation)

**Request:**
```json
{
  "vehicleId": "uuid",
  "driverId": "uuid",
  "routeDate": "2026-02-25",
  "stops": [
    { "depotId": "uuid", "stopOrder": 1 },
    { "depotId": "uuid", "stopOrder": 2 }
  ]
}
```

#### `PUT /api/routes/:id`

**Auth:** Admin only. Only updatable when status = 'pending'.

#### `POST /api/routes/:id/approve`

**Auth:** Admin only

**Request:** (empty body)

**Behavior:**
- Sets route status to `approved`
- Records `approvedByUserId` and `approvedAt`
- Updates all route packages to `in_transit` status
- Sets vehicle status to `in_transit`

**Response (200):** Updated route object

**Errors:** 400 (route not in pending status), 404

#### `POST /api/routes/:id/reject`

**Auth:** Admin only

**Request:**
```json
{
  "reason": "Insufficient vehicle capacity for this route"
}
```

**Behavior:**
- Sets route status to `rejected`
- Packages revert to `registered` status (unassigned)
- Packages' `assigned_vehicle_id` set to null

**Response (200):** Updated route object

---

### 4.8 Deliveries

#### `GET /api/deliveries`

**Auth:** Admin or Driver

**Query params:** `?page=1&pageSize=20&sortBy=deliveredAt&sortOrder=desc&driverId=uuid&dateFrom=2026-02-01&dateTo=2026-02-28`

**Response item shape:**
```json
{
  "id": "uuid",
  "packageId": "uuid",
  "trackingNumber": "ET-20260224-A1B2C3",
  "destinationAddress": "789 Elm St",
  "routeId": "uuid",
  "driverId": "uuid",
  "driverName": "John Driver",
  "deliveredAt": "2026-02-24T14:30:00Z",
  "note": "Left at front door",
  "createdAt": "2026-02-24T14:30:00Z"
}
```

#### `GET /api/deliveries/:id`

**Auth:** Admin or Driver

**Response:** Full delivery object

#### `POST /api/deliveries`

**Auth:** Driver only (must be the assigned driver)

**Request:**
```json
{
  "packageId": "uuid",
  "note": "Left at front door"
}
```

**Behavior:**
- Creates delivery record with driver's ID and current timestamp
- Updates package status to `delivered`
- Records status change in package_status_history

**Validation:**
- Package must exist and be in `out_for_delivery` status
- Driver must be assigned to the vehicle that has this package
- note (optional, max 1000 chars)

**Response (201):** Created delivery object

---

### 4.9 Driver-Specific Endpoints

These endpoints return data scoped to the authenticated driver.

#### `GET /api/driver/routes/today`

**Auth:** Driver only

**Response:** Today's approved/in_progress route for the driver (or null if none).

```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "routeDate": "2026-02-24",
    "status": "approved",
    "vehicleLicensePlate": "CA1234AB",
    "stopCount": 4,
    "packageCount": 12,
    "completedDeliveries": 3,
    "stops": [ "...same as GET /api/routes/:id..." ]
  }
}
```

#### `GET /api/driver/packages`

**Auth:** Driver only

**Query params:** `?status=out_for_delivery`

**Response:** Packages assigned to the driver's vehicle for today's route.

#### `GET /api/driver/deliveries`

**Auth:** Driver only

**Query params:** `?page=1&pageSize=20&sortBy=deliveredAt&sortOrder=desc`

**Response:** All deliveries made by this driver (history).

---

## 5. Folder Structure

```
eturtle/
├── ARCHITECTURE.md
├── package.json                          # Workspace root
├── tsconfig.base.json                    # Shared strict TS config
├── .eslintrc.json                        # Shared lint rules
├── .prettierrc                           # Formatting config
├── .editorconfig
├── .gitignore
│
├── packages/
│   ├── backend/
│   │   ├── package.json
│   │   ├── tsconfig.json                 # Extends ../../tsconfig.base.json
│   │   ├── .env.example
│   │   └── src/
│   │       ├── index.ts                  # Entry: validate env → start server
│   │       ├── server.ts                 # Express app factory
│   │       │
│   │       ├── config/
│   │       │   ├── environment.ts        # Joi env schema + validation
│   │       │   ├── database.ts           # pg Pool from DATABASE_URL
│   │       │   └── constants.ts          # Named constants (roles, statuses, etc.)
│   │       │
│   │       ├── middleware/
│   │       │   ├── authentication.ts     # JWT verify → req.user
│   │       │   ├── authorization.ts      # requireRole('admin')
│   │       │   ├── error-handler.ts      # Centralized next(error) handler
│   │       │   └── request-validator.ts  # express-validator runner
│   │       │
│   │       ├── routes/
│   │       │   ├── index.ts              # Mounts all routers on /api
│   │       │   ├── auth.routes.ts
│   │       │   ├── dashboard.routes.ts
│   │       │   ├── depot.routes.ts
│   │       │   ├── vehicle.routes.ts
│   │       │   ├── user.routes.ts
│   │       │   ├── package.routes.ts
│   │       │   ├── route.routes.ts
│   │       │   ├── delivery.routes.ts
│   │       │   └── driver.routes.ts
│   │       │
│   │       ├── services/
│   │       │   ├── auth.service.ts
│   │       │   ├── dashboard.service.ts
│   │       │   ├── depot.service.ts
│   │       │   ├── vehicle.service.ts
│   │       │   ├── user.service.ts
│   │       │   ├── package.service.ts
│   │       │   ├── package-assignment.service.ts
│   │       │   ├── route.service.ts
│   │       │   ├── route-generation.service.ts
│   │       │   └── delivery.service.ts
│   │       │
│   │       ├── repositories/
│   │       │   ├── depot.repository.ts
│   │       │   ├── vehicle.repository.ts
│   │       │   ├── user.repository.ts
│   │       │   ├── package.repository.ts
│   │       │   ├── package-status-history.repository.ts
│   │       │   ├── route.repository.ts
│   │       │   ├── route-stop.repository.ts
│   │       │   ├── route-package.repository.ts
│   │       │   └── delivery.repository.ts
│   │       │
│   │       ├── models/
│   │       │   ├── depot.model.ts
│   │       │   ├── vehicle.model.ts
│   │       │   ├── user.model.ts
│   │       │   ├── package.model.ts
│   │       │   ├── package-status-history.model.ts
│   │       │   ├── route.model.ts
│   │       │   ├── route-stop.model.ts
│   │       │   ├── route-package.model.ts
│   │       │   ├── delivery.model.ts
│   │       │   └── api-response.model.ts
│   │       │
│   │       ├── utils/
│   │       │   ├── logger.ts             # Winston configuration
│   │       │   ├── response.ts           # successResponse / errorResponse helpers
│   │       │   └── password.ts           # hashPassword / comparePassword
│   │       │
│   │       └── migrations/
│   │           ├── 001-create-depots.sql
│   │           ├── 002-create-vehicles.sql
│   │           ├── 003-create-users.sql
│   │           ├── 004-create-packages.sql
│   │           ├── 005-create-package-status-history.sql
│   │           ├── 006-create-routes.sql
│   │           ├── 007-create-route-stops.sql
│   │           ├── 008-create-route-packages.sql
│   │           ├── 009-create-deliveries.sql
│   │           └── 010-seed-admin-user.sql
│   │
│   ├── admin-dashboard/
│   │   ├── package.json
│   │   ├── angular.json
│   │   ├── tsconfig.json                 # Extends ../../tsconfig.base.json
│   │   ├── tsconfig.app.json
│   │   ├── tsconfig.spec.json
│   │   └── src/
│   │       ├── main.ts
│   │       ├── index.html
│   │       ├── styles.scss               # Imports _variables.scss
│   │       │
│   │       ├── environments/
│   │       │   ├── environment.ts
│   │       │   └── environment.prod.ts
│   │       │
│   │       └── app/
│   │           ├── app.component.ts
│   │           ├── app.component.html
│   │           ├── app.component.scss
│   │           ├── app-routing.module.ts
│   │           ├── app.module.ts
│   │           │
│   │           ├── models/
│   │           │   ├── api-response.model.ts
│   │           │   ├── depot.model.ts
│   │           │   ├── vehicle.model.ts
│   │           │   ├── user.model.ts
│   │           │   ├── package.model.ts
│   │           │   ├── route.model.ts
│   │           │   └── delivery.model.ts
│   │           │
│   │           ├── core/
│   │           │   ├── core.module.ts
│   │           │   ├── guards/
│   │           │   │   └── auth.guard.ts
│   │           │   ├── interceptors/
│   │           │   │   └── auth.interceptor.ts
│   │           │   └── services/
│   │           │       └── auth.service.ts
│   │           │
│   │           ├── shared/
│   │           │   ├── shared.module.ts
│   │           │   ├── styles/
│   │           │   │   └── _variables.scss
│   │           │   └── components/
│   │           │       ├── data-table/
│   │           │       │   ├── data-table.component.ts
│   │           │       │   ├── data-table.component.html
│   │           │       │   └── data-table.component.scss
│   │           │       └── confirmation-dialog/
│   │           │           ├── confirmation-dialog.component.ts
│   │           │           ├── confirmation-dialog.component.html
│   │           │           └── confirmation-dialog.component.scss
│   │           │
│   │           └── features/
│   │               ├── login/
│   │               │   ├── login.module.ts
│   │               │   ├── login-routing.module.ts
│   │               │   ├── login.component.ts
│   │               │   ├── login.component.html
│   │               │   └── login.component.scss
│   │               │
│   │               ├── dashboard/
│   │               │   ├── dashboard.module.ts
│   │               │   ├── dashboard-routing.module.ts
│   │               │   ├── dashboard.component.ts
│   │               │   ├── dashboard.component.html
│   │               │   ├── dashboard.component.scss
│   │               │   └── services/
│   │               │       └── dashboard.service.ts
│   │               │
│   │               ├── packages/
│   │               │   ├── packages.module.ts
│   │               │   ├── packages-routing.module.ts
│   │               │   ├── package-list/
│   │               │   │   ├── package-list.component.ts
│   │               │   │   ├── package-list.component.html
│   │               │   │   └── package-list.component.scss
│   │               │   ├── package-detail/
│   │               │   │   ├── package-detail.component.ts
│   │               │   │   ├── package-detail.component.html
│   │               │   │   └── package-detail.component.scss
│   │               │   ├── package-form/
│   │               │   │   ├── package-form.component.ts
│   │               │   │   ├── package-form.component.html
│   │               │   │   └── package-form.component.scss
│   │               │   └── services/
│   │               │       └── package.service.ts
│   │               │
│   │               ├── routes/
│   │               │   ├── routes.module.ts
│   │               │   ├── routes-routing.module.ts
│   │               │   ├── route-list/
│   │               │   ├── route-detail/
│   │               │   └── services/
│   │               │       └── route.service.ts
│   │               │
│   │               ├── vehicles/
│   │               │   ├── vehicles.module.ts
│   │               │   ├── vehicles-routing.module.ts
│   │               │   ├── vehicle-list/
│   │               │   ├── vehicle-form/
│   │               │   └── services/
│   │               │       └── vehicle.service.ts
│   │               │
│   │               ├── depots/
│   │               │   ├── depots.module.ts
│   │               │   ├── depots-routing.module.ts
│   │               │   ├── depot-list/
│   │               │   ├── depot-form/
│   │               │   └── services/
│   │               │       └── depot.service.ts
│   │               │
│   │               └── users/
│   │                   ├── users.module.ts
│   │                   ├── users-routing.module.ts
│   │                   ├── user-list/
│   │                   ├── user-form/
│   │                   └── services/
│   │                       └── user.service.ts
│   │
│   └── driver-app/
│       ├── package.json
│       ├── ionic.config.json
│       ├── angular.json
│       ├── tsconfig.json                 # Extends ../../tsconfig.base.json
│       ├── tsconfig.app.json
│       └── src/
│           ├── main.ts
│           ├── index.html
│           ├── global.scss
│           │
│           ├── theme/
│           │   └── variables.scss        # Ionic theme + shared variables
│           │
│           ├── environments/
│           │   ├── environment.ts
│           │   └── environment.prod.ts
│           │
│           └── app/
│               ├── app.component.ts
│               ├── app-routing.module.ts
│               ├── app.module.ts
│               │
│               ├── models/
│               │   ├── api-response.model.ts
│               │   ├── package.model.ts
│               │   ├── route.model.ts
│               │   └── delivery.model.ts
│               │
│               ├── core/
│               │   ├── core.module.ts
│               │   ├── guards/
│               │   │   └── auth.guard.ts
│               │   ├── interceptors/
│               │   │   └── auth.interceptor.ts
│               │   └── services/
│               │       └── auth.service.ts
│               │
│               └── pages/
│                   ├── login/
│                   │   ├── login.module.ts
│                   │   ├── login-routing.module.ts
│                   │   ├── login.page.ts
│                   │   ├── login.page.html
│                   │   └── login.page.scss
│                   │
│                   ├── home/
│                   │   ├── home.module.ts
│                   │   ├── home-routing.module.ts
│                   │   ├── home.page.ts
│                   │   ├── home.page.html
│                   │   ├── home.page.scss
│                   │   └── services/
│                   │       └── route.service.ts
│                   │
│                   ├── packages/
│                   │   ├── packages.module.ts
│                   │   ├── packages-routing.module.ts
│                   │   ├── package-list/
│                   │   │   ├── package-list.page.ts
│                   │   │   ├── package-list.page.html
│                   │   │   └── package-list.page.scss
│                   │   ├── package-detail/
│                   │   │   ├── package-detail.page.ts
│                   │   │   ├── package-detail.page.html
│                   │   │   └── package-detail.page.scss
│                   │   └── services/
│                   │       └── package.service.ts
│                   │
│                   └── delivery-history/
│                       ├── delivery-history.module.ts
│                       ├── delivery-history-routing.module.ts
│                       ├── delivery-history.page.ts
│                       ├── delivery-history.page.html
│                       ├── delivery-history.page.scss
│                       └── services/
│                           └── delivery.service.ts
```

---

## 6. Code Standards Summary

| Rule                          | Convention                                       |
|-------------------------------|--------------------------------------------------|
| Indentation                   | 2 spaces                                         |
| Quotes                        | Single quotes                                    |
| Line endings                  | Unix (LF)                                        |
| Max line length               | 100 characters                                   |
| Async                         | `async/await` only, no `.then()` chains          |
| Logging                       | Winston on backend, no `console.log` in prod     |
| TypeScript                    | Strict mode, no `any`                            |
| Variable names                | `camelCase`                                      |
| Function names                | `camelCase`                                      |
| Class/interface names         | `PascalCase`                                     |
| Constants                     | `SCREAMING_SNAKE_CASE`                           |
| DB tables/columns             | `snake_case`                                     |
| API routes                    | `kebab-case`                                     |
| Angular files                 | `kebab-case`                                     |
| CSS classes                   | BEM (`block__element--modifier`)                 |
| No abbreviations              | Full descriptive names only                      |
| Magic numbers/strings         | Extracted to named constants                     |
| Backend architecture          | Route → Service → Repository (strict layers)     |
| SQL                           | Explicit columns only, never `SELECT *`          |
| Passwords                     | Bcrypt, cost factor 12                           |
| JWTs                          | Never logged                                     |
| Input validation              | `express-validator` on every POST/PUT            |
| Env vars                      | Validated on startup with Joi                    |
| Angular forms                 | Reactive forms only                              |
| Angular components            | No business logic, services handle HTTP          |
| Angular subscriptions         | `takeUntil` + `destroy$` pattern                 |
| Angular styles                | SCSS, no inline styles, global `_variables.scss` |
| Ionic                         | Use Ionic components, no custom CSS when avoidable|
| Commits                       | Conventional Commits: `feat(scope): description` |
